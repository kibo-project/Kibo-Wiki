# ğŸ”Œ Kibo - API Technical Documentation

## ğŸ“‹ **MVP Endpoints (Sprint 1-3)**

### **MVP Summary - 13 Essential Endpoints**

| # | Method | Route | Description | Context | Roles | Auth | MVP Priority |
|---|---------|------|-------------|----------|-------|------|-------------|
| 1 | POST | `/api/auth/connect` | Connect wallet and create/update user | Authentication | All | No | âœ… P0 |
| 2 | GET | `/api/auth/profile` | Get authenticated user profile | Authentication | All | Yes | âœ… P0 |
| 3 | GET | `/api/quote` | Calculate quote with specific currencies | Quotes | User, Admin | Yes | âœ… P0 |
| 4 | POST | `/api/orders` | Create order after confirming quote | Orders | User, Admin | Yes | âœ… P0 |
| 5 | GET | `/api/orders` | List user orders (basic filters) | Orders | All | Yes | âœ… P0 |
| 6 | GET | `/api/orders/:id` | Specific order details | Orders | All | Yes | âœ… P0 |
| 7 | POST | `/api/orders/:id/cancel` | Cancel order in PENDING_PAYMENT | Orders | User, Admin | Yes | âœ… P1 |
| 8 | GET | `/api/orders/available` | Available orders to take | Orders | Ally, Admin | Yes | âœ… P0 |
| 9 | POST | `/api/orders/:id/take` | Take order as ally | Orders | Ally, Admin | Yes | âœ… P0 |
| 10 | POST | `/api/orders/:id/proof` | Upload payment proof | Orders | Ally, Admin | Yes | âœ… P0 |
| 11 | GET | `/api/allies/stats` | Authenticated ally statistics | Allies | Ally | Yes | âœ… P1 |
| 12 | POST | `/api/cron/check-timeouts` | Process expired orders | System | System | Cron | âœ… P0 |
| 13 | POST | `/api/cron/update-quotes` | Update market quotes | System | System | Cron | âœ… P0 |

**P0 = Critical Path, P1 = Important for UX**

---

## ğŸ” **MVP Authentication**

### **#1 - POST /api/auth/connect**

**Description**: Connects user wallet via Privy and creates/updates profile in database.

**Input Parameters**:
- `walletAddress` (body, string, required): Wallet address (0x...)
- `signature` (body, string, required): Signature generated by Privy to verify ownership
- `preferredRole` (body, string, optional): "user" or "ally" for new users
- `country` (body, string, optional): User country, default "BO"

**Request Example**:
```json
{
  "walletAddress": "0x742d35Cc6634C0532925a3b8D4014DfF0c1e1c87",
  "signature": "0x...",
  "preferredRole": "ally",
  "country": "BO"
}
```

**Successful Response (200):**
```json
{
  "success": true,
  "user": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "walletAddress": "0x742d35Cc6634C0532925a3b8D4014DfF0c1e1c87",
    "role": "ally",
    "country": "BO",
    "verified": false,
    "successfulOrders": 0,
    "createdAt": "2025-07-29T10:30:00Z"
  },
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expiresIn": 604800
}
```

**Possible Errors**:
- `400 INVALID_SIGNATURE`: Invalid Privy signature
- `400 WALLET_ALREADY_EXISTS`: Wallet already registered with different role
- `400 INVALID_COUNTRY`: Country not supported

**Business Logic**:
- If wallet already exists, updates `lastActive` and returns existing data
- If new, creates user with `preferredRole` or default "user"
- Only Bolivia supported initially
- JWT token valid for 7 days

---

### **#2 - GET /api/auth/profile**

**Description**: Gets complete profile of authenticated user with role-specific data.

**Input Parameters**: None (data comes from JWT token)

**Successful Response (200):**
```json
{
  "success": true,
  "user": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "walletAddress": "0x742d35Cc6634C0532925a3b8D4014DfF0c1e1c87",
    "role": "ally",
    "country": "BO",
    "verified": false,
    "successfulOrders": 15,
    "reputation": 95,
    "lastActive": "2025-07-29T10:30:00Z",
    "createdAt": "2025-07-15T08:15:00Z",
    "allyStats": {
      "totalEarned": 450.75,
      "avgCompletionTime": 8.5,
      "activePenalties": 0
    }
  }
}
```

**Differences by Role**:
- **User**: `allyStats` not included
- **Ally**: Includes `allyStats` with earnings and performance
- **Admin**: Includes additional system metrics

---

## ğŸ’± **MVP Quotes**

### **#3 - GET /api/quote**

**Description**: Calculates quote for fiat to crypto currency conversion with specific amounts.

**Input Parameters**:
- `amountFiat` (query, number, required): Amount in fiat currency (10-10000)
- `fiatCurrency` (query, string, required): Fiat currency ("BOB", "USD", etc.)
- `cryptoToken` (query, string, required): Desired crypto token ("USDT", "USDC", etc.)
- `network` (query, string, optional): Blockchain network, default "mantle"

**Request Example**:
```http
GET /api/quote?amountFiat=300&fiatCurrency=BOB&cryptoToken=USDT&network=mantle
```

**Successful Response (200):**
```json
{
  "success": true,
  "quote": {
    "id": "quote_550e8400-e29b-41d4",
    "amountFiat": 300.00,
    "amountCrypto": 43.06,
    "rate": 6.97,
    "networkFee": 0.10,
    "kiboFee": 0.00,
    "totalAmount": 43.16,
    "expiresAt": "2025-07-29T10:33:00Z",
    "escrowAddress": "0x1234...abcd",
    "rateSource": "binance_api/coingecko",
    "rateTimestamp": "2025-07-29T10:30:00Z"
  }
}
```

**Validations**:
- `amountFiat` between 10 and 10,000 (according to fiatCurrency)
- `fiatCurrency` must be supported currency
- `cryptoToken` must be supported token on specified network

**Business Logic**:
- Quote valid for exactly 3 minutes
- Includes estimated network fee according to network
- MVP: Kibo fee = 0
- Does not persist data (stateless for MVP)

---

## ğŸ“‹ **MVP Order Management**

### **#4 - POST /api/orders**

**Description**: Creates definitive order after user confirms quote and is ready to pay.

**Input Parameters**:
- `quoteId` (body, string, required): Valid quote ID
- `qrImageUrl` (body, string, optional): QR image URL to show to ally

**Response Exitosa (201)**:
```json
{
  "success": true,
  "order": {
    "id": "order_770f8611-f49d-52f6",
    "status": "PENDING_PAYMENT",
    "amountFiat": 300.00,
    "amountCrypto": 43.06,
    "fiatCurrency": "BOB",
    "cryptoToken": "USDT",
    "network": "mantle",
    "escrowAddress": "0x1234...abcd",
    "expiresAt": "2025-07-29T10:33:00Z",
    "createdAt": "2025-07-29T10:30:00Z",
    "qrImageUrl": "https://storage.supabase.co/qrs/qr_123.jpg"
  }
}
```

**Validations**:
- Quote must exist and not be expired
- User must be owner of the quote
- User cannot have more than 3 active orders simultaneously

---

### **#5 - GET /api/orders (Simplified for MVP)**

**Description**: Lists authenticated user orders with basic filters.

**Input Parameters**:
- `status` (query, string, optional): Filter by status
- `limit` (query, number, optional): Default 20, max 100
- `offset` (query, number, optional): Default 0

**Successful Response (200):**
```json
{
  "success": true,
  "orders": [
    {
      "id": "order_770f8611-f49d-52f6",
      "status": "TAKEN",
      "amountFiat": 300.00,
      "amountCrypto": 43.06,
      "fiatCurrency": "BOB",
      "cryptoToken": "USDT",
      "createdAt": "2025-07-29T10:30:00Z",
      "takenAt": "2025-07-29T10:32:00Z",
      "expiresAt": "2025-07-29T10:37:00Z",
      "secondsRemaining": 180,
      "ally": {
        "id": "ally_123",
        "walletAddress": "0x5678...efgh"
      }
    }
  ],
  "pagination": {
    "total": 45,
    "limit": 20,
    "offset": 0,
    "hasMore": true
  }
}
```

**Differences by Role**:
- **User**: Only their own orders as creator
- **Ally**: Their orders as creator + orders they processed as ally
- **Admin**: All orders in the system

---

### **#6 - GET /api/orders/:id**

**Description**: Gets complete details of a specific order.

**Successful Response (200):**
```json
{
  "success": true,
  "order": {
    "id": "order_770f8611-f49d-52f6",
    "status": "COMPLETED",
    "amountFiat": 300.00,
    "amountCrypto": 43.06,
    "fiatCurrency": "BOB",
    "cryptoToken": "USDT",
    "network": "mantle",
    "qrData": "BANCO_UNION|123456789|REF_12345",
    "qrImageUrl": "https://storage.supabase.co/qrs/qr_123.jpg",
    "proofUrl": "https://storage.supabase.co/proofs/proof_456.jpg",
    "createdAt": "2025-07-29T10:30:00Z",
    "takenAt": "2025-07-29T10:32:00Z",
    "completedAt": "2025-07-29T10:35:00Z",
    "escrowTxHash": "0xabc123...",
    "releaseTxHash": "0xdef456...",
    "user": {
      "id": "user_123",
      "walletAddress": "0x1234...abcd"
    },
    "ally": {
      "id": "ally_456",
      "walletAddress": "0x5678...efgh",
      "successfulOrders": 15
    },
    "timeline": [
      {
        "status": "PENDING_PAYMENT",
        "timestamp": "2025-07-29T10:30:00Z"
      },
      {
        "status": "AVAILABLE",
        "timestamp": "2025-07-29T10:31:00Z"
      },
      {
        "status": "TAKEN",
        "timestamp": "2025-07-29T10:32:00Z"
      },
      {
        "status": "COMPLETED",
        "timestamp": "2025-07-29T10:35:00Z"
      }
    ]
  }
}
```

**Permissions**:
- **User**: Only orders where they are creator or ally
- **Ally**: Only orders where they are creator or ally
- **Admin**: Any order in the system

---

### **#7 - POST /api/orders/:id/cancel (NEW MVP)**

**Description**: User cancels order only in PENDING_PAYMENT status before paying USDT to escrow.

**Successful Response (200):**
```json
{
  "success": true,
  "order": {
    "id": "order_770f8611-f49d-52f6",
    "status": "CANCELLED",
    "cancelledAt": "2025-07-29T10:31:00Z",
    "reason": "USER_CANCELLED"
  },
  "message": "Order cancelled successfully"
}
```

**Validations**:
- Only orders in status="PENDING_PAYMENT"
- Only the creator user can cancel
- Cannot be cancelled after paying to escrow

**Possible Errors**:
- `400 CANNOT_CANCEL`: Order already progressed beyond PENDING_PAYMENT
- `403 NOT_ORDER_OWNER`: User is not the order creator

---

### **#8 - GET /api/orders/available**

**Description**: Lists available orders that allies can take (only status=AVAILABLE).

**Input Parameters**:
- `country` (query, string, optional): Filter by country, default based on ally
- `minAmount` (query, number, optional): Minimum amount in fiat
- `maxAmount` (query, number, optional): Maximum amount in fiat
- `sortBy` (query, string, optional): "createdAt", "expiresAt", "amount", default "expiresAt"
- `limit` (query, number, optional): Default 50, max 200

**Successful Response (200):**
```json
{
  "success": true,
  "orders": [
    {
      "id": "order_880g9722-g50e-63g7",
      "amountFiat": 300.00,
      "amountCrypto": 43.06,
      "fiatCurrency": "BOB",
      "cryptoToken": "USDT",
      "createdAt": "2025-07-29T10:32:00Z",
      "expiresAt": "2025-07-29T10:37:00Z",
      "secondsRemaining": 180,
      "userCountry": "BO",
      "estimatedGain": 43.06,
      "bankingInfo": {
        "bank": "Banco UniÃ³n",
        "reference": "KBO025"
      }
    }
  ],
  "metadata": {
    "totalAvailable": 12,
    "avgWaitTime": 245,
    "yourActiveOrders": 0
  }
}
```

**Validations**:
- Only non-penalized allies can access
- Only orders from the same ally's country
- Excludes orders that the ally previously let expire

---

### **#9 - POST /api/orders/:id/take**

**Description**: Ally takes available order exclusively with concurrency control.

**Successful Response (200):**
```json
{
  "success": true,
  "order": {
    "id": "order_880g9722-g50e-63g7",
    "status": "TAKEN",
    "amountFiat": 300.00,
    "amountCrypto": 43.06,
    "qrData": "BANCO_UNION|123456789|REF_12345",
    "qrImageUrl": "https://storage.supabase.co/qrs/qr_567.jpg",
    "takenAt": "2025-07-29T10:35:00Z",
    "expiresAt": "2025-07-29T10:40:00Z",
    "bankingDetails": {
      "bank": "Banco UniÃ³n",
      "accountNumber": "123456789",
      "beneficiary": "Juan PÃ©rez",
      "reference": "KBO025",
      "exactAmount": "300.00 BOB"
    }
  }
}
```

**Critical Validations**:
- Order must be in status="AVAILABLE"
- Order must not be expired
- Ally must not have active penalties
- Ally must not have another active order

**Business Logic**:
- Atomic transaction with SELECT FOR UPDATE
- Updates expires_at to NOW() + 5 minutes
- QR and banking details only visible after taking

---

### **#10 - POST /api/orders/:id/proof**

**Description**: Ally uploads bank payment proof, triggering MVP auto-approval.

**Input Parameters**:
- `proof` (body, File, required): Proof image (multipart/form-data)
- `bankTransactionId` (body, string, optional): Bank transaction ID
- `notes` (body, string, optional): Additional notes from ally

**Successful Response (200):**
```json
{
  "success": true,
  "order": {
    "id": "order_880g9722-g50e-63g7",
    "status": "COMPLETED",
    "proofUrl": "https://storage.supabase.co/proofs/proof_789.jpg",
    "completedAt": "2025-07-29T10:38:00Z",
    "releaseTransactionHash": "0x789abc...",
    "bankTransactionId": "TXN123456"
  },
  "payment": {
    "amountReleased": 43.06,
    "recipientWallet": "0x5678...efgh",
    "networkFee": 0.008
  },
  "message": "Payment proof uploaded and approved. 43.06 USDT released to your wallet."
}
```

**Validations**:
- Order must be in status="TAKEN"
- Ally must be the one who took the order
- Maximum file 5MB, formats: JPG, PNG, HEIC

**MVP Business Logic**:
- **Auto-approval**: Proof uploaded = funds released immediately
- Updates order to status="COMPLETED"
- Transfers USDT from escrow to ally's wallet
- Increments ally's `successfulOrders`

---

## ğŸ¤ **MVP Allies**

### **#11 - GET /api/allies/stats (NEW MVP)**

**Description**: Authenticated ally statistics, separated from admin endpoint.

**Successful Response (200):**
```json
{
  "success": true,
  "stats": {
    "totalOrders": 42,
    "completedOrders": 40,
    "successRate": 95.2,
    "totalEarned": 1250.75,
    "avgCompletionTime": 7.2,
    "activePenalties": 0,
    "todayStats": {
      "ordersCompleted": 3,
      "earned": 125.50,
      "avgTime": 6.8
    },
    "weekStats": {
      "ordersCompleted": 18,
      "earned": 650.25,
      "avgTime": 7.5
    },
    "penalties": {
      "total": 2,
      "lastPenalty": "2025-07-20T15:30:00Z",
      "reason": "TIMEOUT"
    }
  }
}
```

**Authentication**: JWT token required

**Roles with Access**: Ally only

**Business Logic**:
- Authenticated ally data only
- Real-time statistics
- Includes historical and recent performance

---

## â° **MVP System & Cron**

### **#12 - POST /api/cron/check-timeouts**

**Description**: Automatic job that processes expired orders every 30 seconds.

**Successful Response (200):**
```json
{
  "success": true,
  "processed": {
    "expiredPendingPayment": 2,
    "expiredAvailable": 1,
    "expiredTaken": 3,
    "refundsInitiated": 4,
    "penaltiesApplied": 3
  },
  "executionTime": 1.25,
  "timestamp": "2025-07-29T11:00:30Z"
}
```

**Business Logic**:
- Runs every 30 seconds via Vercel Cron
- Processes all timeout types according to status
- Initiates automatic refunds where appropriate
- Applies penalties to allies

---

### **#13 - POST /api/cron/update-quotes**

**Description**: Updates quotes from external APIs every 30 seconds.

**Successful Response (200):**
```json
{
  "success": true,
  "updated": {
    "USDT/BOB": {
      "oldRate": 6.95,
      "newRate": 6.97,
      "change": 0.29,
      "source": "binance_api/coingecko"
    }
  },
  "errors": [],
  "timestamp": "2025-07-29T11:00:30Z"
}
```

**Business Logic**:
- Queries binance_api/coingecko API for USDT/USD
- Calculates BOB rate using local source
- Marks previous quote as inactive
- Alerts if change > 5%

---

## ğŸ”’ **MVP Authentication & Security**

### **JWT Token Structure**
```json
{
  "userId": "user_123",
  "walletAddress": "0x1234...abcd",
  "role": "ally",
  "country": "BO",
  "iat": 1690627200,
  "exp": 1691232000
}
```

### **Rate Limiting MVP**

| Category | Limit | Window | Scope |
|-----------|--------|---------|-------|
| Authentication | 5 req/min | Per IP | Global |
| Quote APIs | 10 req/min | Per user | Individual |
| Order APIs | 20 req/min | Per user | Individual |
| Cron Jobs | Unlimited | - | System |

---

# ğŸš€ **Nice to Have - Post MVP (Sprint 4+)**

## ğŸ“‹ **Endpoints para Futuras Versiones**

### **Authentication Avanzada**
- **POST /api/auth/logout** - Logout con blacklist de tokens
- **POST /api/auth/refresh** - Renovar tokens antes de expirar

### **Quotes Avanzadas**
- **POST /api/quote/refresh** - Actualizar quote expirado
- **GET /api/quotes/history** - HistÃ³rico para grÃ¡ficos admin

### **Upload Independiente**
- **POST /api/upload/qr** - Upload QR como fallback
- **POST /api/upload/proof** - Upload proof independiente
- **DELETE /api/upload/:filename** - Eliminar archivos

### **Admin Dashboard Completo**
- **GET /api/admin/dashboard** - MÃ©tricas completas tiempo real
- **GET /api/admin/orders** - Vista admin con filtros avanzados
- **GET /api/admin/users** - GestiÃ³n usuarios completa
- **GET /api/admin/config** - ConfiguraciÃ³n sistema
- **PUT /api/admin/config** - Actualizar configuraciÃ³n
- **GET /api/admin/penalties** - Ver penalizaciones (solo lectura)

### **System Avanzado**
- **POST /api/cron/cleanup** - Limpieza datos antiguos
- **POST /api/cron/process-refunds** - Cola refunds separada
- **GET /api/system/health** - Health check completo

### **Order Management Avanzado**
- **GET /api/orders** (filtros completos) - Con fechas, rangos, ordenamiento avanzado
- **POST /api/orders/:id/dispute** - Sistema disputas
- **GET /api/orders/:id/logs** - Logs detallados orden

---

## ğŸ“Š **Prioritization Summary**

### **MVP Essentials (13 endpoints)**
- **Complete functional flow**: User â†’ Quote â†’ Order â†’ Ally â†’ Payment â†’ Completed
- **Basic authentication**: Privy login + profile
- **Automatic system**: Timeouts + quote updates
- **Real-time tracking**: Supabase Realtime (no polling endpoints) + ally stats

### **Nice to Have (18+ endpoints)**
- **Advanced admin**: Dashboard + metrics + configuration
- **Flexible upload**: Independent endpoints
- **Robust auth**: Logout + refresh + blacklist
- **Complete system**: Cleanup + health checks + disputes

**ğŸ¯ Benefits of this separation:**
- **MVP deliverable in 7 weeks**
- **Complete core functionality**
- **Clear roadmap for post-MVP**
- **Less initial complexity**

**ğŸ“ Real-time Note:**
- **Removed**: `GET /api/orders/:id/status` (polling endpoint)
- **Replaced by**: Supabase Realtime subscriptions
- **Benefit**: Instant updates vs polling every 8-10 seconds
- **Result**: Better UX and lower server load

---

**ğŸ”‘ Next steps**: Implement the 13 MVP endpoints following exactly these specifications, leaving Nice to Have for future versions.